# üé¨ Video Extractor MVP - Thumbnail Extraction API

## üìã Descripci√≥n

Sistema as√≠ncrono de extracci√≥n de thumbnails de videos que utiliza una API externa de procesamiento de video con arquitectura de colas Redis y BullMQ.

## üèóÔ∏è Arquitectura

```
[Cliente] ‚Üí [Endpoint Enqueue] ‚Üí [Redis Queue] ‚Üí [Worker] ‚Üí [Video API] ‚Üí [Callback URL]
```

### Componentes:

1. **Endpoint de Encolamiento** (`POST /video-extractor/enqueue`)
2. **Cola Redis** (BullMQ) para gestionar trabajos
3. **Worker/Procesador** que hace polling a la API externa
4. **Callback** para entregar resultados con file_ids de OpenAI

## üöÄ Endpoints Disponibles

### 1. `POST /video-extractor/enqueue`

Encola una nueva extracci√≥n de thumbnails.

**Body:**

```json
{
  "videoUrl": "https://ejemplo.com/video.mp4",
  "callbackUrl": "https://webhook.site/31b126fb-82ba-4274-931a-5ff1ab51b41c",
  "requestId": "optional-custom-id",
  "metadata": {
    "cualquier": "dato adicional"
  },
  "options": {
    "fps": 1.0,
    "width": 640,
    "height": 480,
    "format": "jpg",
    "maxThumbnails": 10
  }
}
```

**Par√°metros:**
- `videoUrl` (requerido): URL del video a procesar
- `callbackUrl` (requerido): URL donde recibir el resultado
- `requestId` (opcional): ID personalizado para la petici√≥n
- `metadata` (opcional): Datos adicionales
- `options` (opcional): Configuraci√≥n de extracci√≥n
  - `fps` (0.1-30.0, default: 1.0): Thumbnails por segundo
  - `width` (64-1920, default: 320): Ancho en p√≠xeles
  - `height` (64-1080, default: 240): Alto en p√≠xeles
  - `format` (jpg/jpeg/png/webp, default: jpg): Formato de salida
  - `maxThumbnails` (1-100, default: 10): M√°ximo n√∫mero de thumbnails

**Response:**

```json
{
  "success": true,
  "requestId": "uuid-generado-automaticamente",
  "message": "Extracci√≥n de thumbnails encolada exitosamente..."
}
```

### 2. `GET /video-extractor/status/{requestId}`

Consulta el estado de una extracci√≥n.

**Response:**

```json
{
  "requestId": "uuid-de-la-peticion",
  "status": "completed",
  "state": "completed",
  "progress": 100,
  "result": {
    "success": true,
    "thumbnails": ["thumbnail_0001_1.50s.jpg"],
    "openaiFileIds": ["file-abc123"],
    "totalThumbnails": 5
  }
}
```

### 3. `GET /video-extractor/queue/stats`

Obtiene estad√≠sticas de la cola.

**Response:**

```json
{
  "waiting": 2,
  "active": 1,
  "completed": 45,
  "failed": 1,
  "total": 49
}
```

### 4. `GET /video-extractor/health`

Verifica el estado del servicio.

**Response:**

```json
{
  "status": "healthy",
  "videoExtractor": {
    "configured": true,
    "apiHealthy": true
  },
  "queue": {
    "waiting": 0,
    "active": 1,
    "completed": 10,
    "failed": 0
  }
}
```

### 5. `POST /video-extractor/callback/test`

Endpoint de prueba para recibir callbacks.

## ‚öôÔ∏è Configuraci√≥n Requerida

### Variables de Entorno:

```bash
# Video Extractor API
VIDEO_EXTRACTOR_API_URL=https://tu-api-privada.render.com

# Redis (para BullMQ)
REDIS_URL=redis://localhost:6379

# Configuraci√≥n opcional
VIDEO_EXTRACTOR_POLLING_INTERVAL=2000  # ms
VIDEO_EXTRACTOR_MAX_POLLING_ATTEMPTS=300  # intentos
```

### Configuraci√≥n por Defecto:

- **FPS:** 1.0 (thumbnails por segundo)
- **Dimensiones:** 320x240 p√≠xeles
- **Formato:** JPG
- **Max Thumbnails:** 10
- **Polling Interval:** 2000ms (2 segundos)
- **Max Polling Attempts:** 300 (10 minutos)

> **Nota T√©cnica:** El sistema se comunica con una API externa privada en Render.com que procesa los videos y sube autom√°ticamente los thumbnails a OpenAI storage.

## üîÑ Flujo de Trabajo

### 1. **Encolamiento**

```bash
curl -X POST "http://localhost:3000/video-extractor/enqueue" \
  -H "Content-Type: application/json" \
  -d '{
    "videoUrl": "https://sample-videos.com/zip/10/mp4/SampleVideo_720x480_1mb.mp4",
    "callbackUrl": "https://mi-app.com/video-result",
    "options": {
      "fps": 0.5,
      "width": 640,
      "height": 480,
      "format": "png"
    }
  }'
```

### 2. **Procesamiento As√≠ncrono**

- El worker toma el job de la cola
- Env√≠a petici√≥n a la API externa `/extract-thumbnails`
- Obtiene `task_id` de la API externa
- Hace polling cada 2 segundos hasta completarse

### 3. **Polling a la API Externa**

```bash
# El worker hace esto autom√°ticamente
GET https://tu-api-privada.render.com/status/{task_id}
```

### 4. **Entrega de Resultado**

```bash
# El worker env√≠a esto a tu callbackUrl
POST https://tu-dominio.com/callback
Content-Type: application/json

{
  "success": true,
  "requestId": "uuid-de-tu-peticion",
  "taskId": "task-id-de-la-api-externa",
  "thumbnails": ["thumbnail_0001_1.50s.jpg", "thumbnail_0002_2.50s.jpg"],
  "openaiFileIds": ["file-abc123", "file-def456"],
  "totalThumbnails": 5,
  "duration": 30.5,
  "processingTime": 45000,
  "completedAt": "2024-01-15T10:30:00.000Z",
  "metadata": {
    "taskId": "external-task-id",
    "webhookDelivered": true,
    "extractionOptions": {
      "fps": 0.5,
      "width": 640,
      "height": 480,
      "format": "png"
    }
  }
}
```

## üìä Logs del Sistema

### Encolamiento Exitoso:

```
üì• [VIDEO_CONTROLLER] === NUEVA PETICI√ìN DE EXTRACCI√ìN ===
üì• [VIDEO_CONTROLLER] Video URL: https://sample-videos.com/...
üì§ [VIDEO_QUEUE] Job encolado exitosamente en 15ms
üé¨ [VIDEO_QUEUE] Opciones: FPS=0.5, Tama√±o=640x480, Formato=png
‚úÖ [VIDEO_CONTROLLER] Petici√≥n encolada exitosamente en 18ms
```

### Procesamiento del Worker:

```
üöÄ [VIDEO_PROCESSOR] === PROCESANDO JOB ===
üé¨ [VIDEO_EXTRACTOR] === INICIANDO EXTRACCI√ìN DE THUMBNAILS ===
‚úÖ [VIDEO_EXTRACTOR] Extracci√≥n iniciada exitosamente en 342ms
‚è∞ [VIDEO_EXTRACTOR] === INICIANDO POLLING ===
‚úÖ [VIDEO_EXTRACTOR] Extracci√≥n completada en 45023ms despu√©s de 23 intentos
üñºÔ∏è [VIDEO_EXTRACTOR] Thumbnails generados: 5
‚òÅÔ∏è [VIDEO_EXTRACTOR] OpenAI File IDs: 5
üì° [VIDEO_PROCESSOR] Enviando resultado a callback
üéâ [VIDEO_PROCESSOR] === JOB COMPLETADO EXITOSAMENTE ===
```

## üß™ Testing

### Prerequisitos:

```bash
# 1. Iniciar Redis (local o Docker)
docker run -d -p 6379:6379 redis:alpine

# 2. Configurar variables de entorno
export VIDEO_EXTRACTOR_API_URL=https://tu-api-privada.render.com
export REDIS_URL=redis://localhost:6379

# 3. Iniciar la aplicaci√≥n
bun dev
```

### Tests B√°sicos:

#### 1. **Health Check**

```bash
curl http://localhost:3000/video-extractor/health
```

#### 2. **Extracci√≥n Simple**

```bash
curl -X POST "http://localhost:3000/video-extractor/enqueue" \
  -H "Content-Type: application/json" \
  -d '{
    "videoUrl": "https://sample-videos.com/zip/10/mp4/SampleVideo_720x480_1mb.mp4",
    "callbackUrl": "http://localhost:3000/video-extractor/callback/test"
  }'
```

#### 3. **Monitorear Estado**

```bash
# Usar el requestId devuelto en el paso anterior
curl http://localhost:3000/video-extractor/status/your-request-id
```

## ‚ö° Casos de Uso

### 1. **An√°lisis de Video Educativo**

```json
{
  "videoUrl": "https://mi-plataforma.com/video-leccion-1.mp4",
  "callbackUrl": "https://mi-app.com/video-analysis",
  "metadata": { "type": "educational", "course": "math-101" },
  "options": {
    "fps": 0.2,
    "width": 480,
    "height": 270,
    "format": "jpg",
    "maxThumbnails": 15
  }
}
```

### 2. **Procesamiento de Contenido de Redes Sociales**

```json
{
  "videoUrl": "https://social-platform.com/user-video.mp4",
  "callbackUrl": "https://mi-app.com/social-content",
  "options": {
    "fps": 1.0,
    "width": 320,
    "height": 320,
    "format": "webp",
    "maxThumbnails": 8
  }
}
```

### 3. **An√°lisis de Presentaciones**

```json
{
  "videoUrl": "https://conference.com/presentation-recording.mp4",
  "callbackUrl": "https://mi-app.com/presentation-analysis",
  "metadata": { "event": "tech-conference-2024", "speaker": "john-doe" },
  "options": {
    "fps": 0.1,
    "width": 800,
    "height": 600,
    "format": "png",
    "maxThumbnails": 20
  }
}
```

## üö® Manejo de Errores

### Errores Comunes:

#### 1. **API URL No Configurada**

```json
{
  "statusCode": 503,
  "message": "Video Extractor API no est√° configurada..."
}
```

#### 2. **Video URL Inv√°lida**

```json
{
  "statusCode": 400,
  "message": "Video URL no tiene un formato v√°lido"
}
```

#### 3. **Par√°metros Fuera de Rango**

```json
{
  "statusCode": 400,
  "message": "FPS debe estar entre 0.1 y 30.0"
}
```

#### 4. **Timeout de API Externa**

```json
{
  "success": false,
  "error": "Timeout: La extracci√≥n no se complet√≥ despu√©s de 300 intentos"
}
```

#### 5. **Error de Callback**

```json
{
  "success": true,
  "requestId": "uuid",
  "metadata": {
    "callbackError": "Request failed with status code 404",
    "callbackDelivered": false
  }
}
```

## üìà M√©tricas y Monitoreo

### Logs de Rendimiento:

- **Tiempo de encolamiento:** ~15-50ms
- **Tiempo de extracci√≥n:** 30-300 segundos (seg√∫n duraci√≥n y configuraci√≥n)
- **Tiempo de callback:** ~100-500ms

### Estado de la Cola:

```
üìä [VIDEO_QUEUE] Estado cola - En espera: 2, Activos: 1
```

## üîß Configuraci√≥n Avanzada

### Personalizar Timeouts:

```bash
# Aumentar tiempo m√°ximo de polling (por defecto 10 minutos)
VIDEO_EXTRACTOR_MAX_POLLING_ATTEMPTS=600  # 20 minutos

# Cambiar intervalo de polling (por defecto 2 segundos)
VIDEO_EXTRACTOR_POLLING_INTERVAL=3000     # 3 segundos
```

### Formatos y L√≠mites:

- **Formatos de video soportados:** MP4, AVI, MOV, MKV, WebM, FLV
- **Formatos de imagen soportados:** JPG, JPEG, PNG, WebP
- **FPS m√≠nimo/m√°ximo:** 0.1 - 30.0
- **Dimensiones:** 64x64 hasta 1920x1080
- **Thumbnails m√°ximos:** 1-100

## üîó Integraci√≥n con OpenAI

El sistema autom√°ticamente:

1. Procesa el video en la API externa
2. Genera thumbnails seg√∫n la configuraci√≥n
3. Sube los thumbnails a OpenAI storage
4. Devuelve los `file_ids` para uso inmediato con GPT-4 Vision

### Ejemplo de uso con OpenAI:

```javascript
// Despu√©s de recibir el callback con file_ids
const fileIds = result.openaiFileIds; // ["file-abc123", "file-def456"]

// Usar con GPT-4 Vision
const response = await openai.chat.completions.create({
  model: "gpt-4-vision-preview",
  messages: [
    {
      role: "user",
      content: [
        { type: "text", text: "Analiza estos thumbnails del video" },
        ...fileIds.map(fileId => ({
          type: "image_file",
          image_file: { file_id: fileId }
        }))
      ]
    }
  ]
});
```

## üéØ Pr√≥ximos Pasos (Fuera del MVP)

1. **Dashboard de Monitoreo** - UI para ver estado de extracciones
2. **Retry Logic** - Reintentos autom√°ticos con backoff exponencial
3. **Rate Limiting** - Limitar peticiones por usuario
4. **Webhooks Seguros** - Firma de callbacks con HMAC
5. **Cach√© de Resultados** - Almacenar file_ids para videos ya procesados
6. **An√°lisis con IA** - Integraci√≥n autom√°tica con GPT-4 Vision
7. **Batch Processing** - Procesar m√∫ltiples videos simult√°neamente

¬°El MVP est√° listo para extraer thumbnails de videos de forma as√≠ncrona! üöÄ
